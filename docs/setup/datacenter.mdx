---
sidebar_position: 3
toc_max_heading_level: 4
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import DownloadWindowsInstaller from '@site/src/components/DownloadWindowsInstaller';

# CloudRift Datacenter Service

CloudRift Datacenter Service is a system service that connects to the CloudRift platform allowing
you to manage and lease your datacenter computational resources. Together with CloudRift CLI,
Rest API, and other developer tools, it provides a comprehensive solution for managing your datacenter.

## Sign Up & Activate the Account

To start using CloudRift please sign-up at [cloudrift.ai](https://cloudrift.ai).

## Configuring Rentable Machines

> **Note:** All steps below are included in our setup script, which can be found on [GitHub](https://github.com/cloudrift-ai/rift-utils)

### Prerequisites

Install `curl` and `sudo` if they are not installed on your system.

```shell
sudo apt-get update
sudo apt-get install -y curl sudo
```

### Docker Service

You need to install Docker Engine and NVidia Container Toolkit (if you have NVidia GPUs) if you want your node to serve Docker containers.

#### 1. Install Docker engine

Up-to-date instructions can be found on [Docker Website](https://docs.docker.com/engine/install/debian/).

```shell
# Uninstall conflicting packages
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done

# Setup repository
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
$(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install docker
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### 2. Install NVidia Drivers

You can check installed NVIDIA packages using the following command:

```shell
dpkg -l | grep -i nvidia
```

To check version of the installed NVIDIA driver, you can use:

```shell
nvidia-smi
# or 
cat /proc/driver/nvidia/version
```

> **Note:** NVIDIA driver version and NVIDIA Utils version should match to `nvidia-smi` command to work properly.
> **Note**: On Ubuntu **Failed to initialize NVML: Driver/library version mismatch** may happen, because of **unattended-upgrades** process. It automatically downloads and installs updates without user intervention. Usually it's enough to reboot the system with `reboot now`.


You can check if NVIDIA driver is loaded and used by the system using the following command:

```shell
lsmod | grep nvidia
# or check if driver is used by your GPU:
lspci -k | grep -EA3 'VGA|3D|Display'
```

To install the latest NVIDIA driver, you can use the following command:

```shell
sudo apt-get install -y nvidia-driver-570-server nvidia-utils-570-server
```

#### 3. Install NVidia Container Toolkit (if you have NVidia GPUs)

Up-to-date instructions can be found on [NVidia Website](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html).

```shell
# Configure the repository
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list    

# Install the NVIDIA Container Toolkit
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit

# Configure
sudo nvidia-ctk runtime configure --runtime=docker

# Restart Docker
sudo systemctl restart docker
```

### Virtual Machine Service

If your node will serve virtual machines, you need to install and configure Libvirt. To allow Libvirt to use GPU device in pass-through mode, you have to make sure NVIDIA driver is not installed or not used by the system.

You can check if NVIDIA driver is loaded and used by the system using the following command:

```shell
lsmod | grep nvidia
# or check if driver is used by your GPU:
lspci -k | grep -EA3 'VGA|3D|Display'
```

#### 0. Remove NVIDIA driver (if installed)

If NVIDIA driver is installed you can remove it using the following command:

```shell
sudo apt-get remove --purge '^nvidia-.*'
sudo apt autoremove
echo 'nouveau' | sudo tee -a /etc/modules
sudo rm /etc/X11/xorg.conf
```

Restart your machine to apply the changes.

#### 1. Install system dependencies

Install additional packages required by the service.

```shell
sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system genisoimage whois
```

#### 2. Configure Libvirt

Rift system service is being run using root user, thus need set up libvirt to run under root as well.
Edit `/etc/libvirt/qemu.conf` and modify the `user` and `group` settings

```shell
user = "root"
group = "root"
```

Then restart the `libvirtd` service:

```shell
sudo systemctl restart libvirtd
```

### CloudRift System Service

Any Linux distribution is supported, but we typically test on Ubuntu 22.04.

```shell
curl -L https://cloudrift.ai/install-rift-service.sh | sudo sh
```

#### 1. CloudRift CLI

Install CloudRift CLI to configure the system service.

```shell
curl -L https://cloudrift.com/install-rift.sh | sh
```

#### 2. Configure credentials

Configure credentials using rift command line tool by running

```shell
sudo rift configure
```

Note that we're running rift system service as root, so we need to configure it as root.

You can also edit the config manually, it is located in `/root/.config/cloudrift/credentials.yml`

#### 3. Restart system service and check status

Restart CloudRift system service and check status of the service and Docker Engine.

```shell
sudo systemctl restart rift
sudo systemctl status rift
sudo systemctl status docker
```

## Testing CloudRift Setup

### 1. Install CloudRift CLI

Install CloudRift CLI on your local machine. Installation instructions vary depending on your OS.

<Tabs groupId="operating-systems">
  <TabItem value="win" label="Windows">
    <DownloadWindowsInstaller/>
  </TabItem>
  <TabItem value="mac" label="Mac">

  ```shell
  curl -L https://cloudrift.ai/install-rift.sh | sh
  ```

  </TabItem>
  <TabItem value="linux" label="Linux">

  ```shell
  curl -L https://cloudrift.ai/install-rift.sh | sh
  ```

  </TabItem>
</Tabs>

### 2. Configure credentials

Configure your credentials using rift command line tool by running:

```shell
rift configure
```

### 3. Inspect the cluster

Inspect the cluster. You should see all machines that you've installed CloudRift service on:

```shell
rift cluster info
```

### 4. Run your first job

Run your first job. For example, to run a simple echo command:

```shell
rift docker run --rm alpine echo "Hello CloudRift"
```

## Next Steps

For more information on how to use CloudRift platform to lease your computational resources
please send a request to <a href="mailto:dc@cloudrift.ai">dc@cloudrift.ai</a>.
We support a variety of integrations, e.g. marketplace, white-label website, custom integration, and more.
