---
sidebar_position: 3
toc_max_heading_level: 4
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import DownloadWindowsInstaller from '@site/src/components/DownloadWindowsInstaller';

# CloudRift Datacenter Service

CloudRift Datacenter Service is a system service that connects to the CloudRift platform, allowing
you to manage and lease your datacenter computational resources. Together with CloudRift CLI,
REST API, and other developer tools, it provides a comprehensive solution for managing your datacenter.

## Node Operation Modes

CloudRift nodes can operate in three distinct modes, depending on your infrastructure and requirements:

- **Docker Mode:** Run containerized workloads using Docker Engine. This is the most common setup for GPU and CPU resource sharing.
- **Virtual Machine (VM) Mode:** Serve virtual machines using Libvirt and QEMU/KVM. Suitable for scenarios requiring full VM isolation or custom OS environments.
- **Bare Metal Mode:** Lease entire physical machines directly, without virtualization or containers. Ideal for maximum performance or specialized hardware needs.

You can configure your node to support one or more of these modes based on your use case.

:::info

**Coming Soon:** CloudRift will soon support MAAS (Metal-as-a-Service) for automated bare metal provisioning and management.

:::

## Sign Up & Activate the Account

To start using CloudRift, please sign up at [cloudrift.ai](https://cloudrift.ai).

## Configuring Rentable Machines

:::info

All steps below are included in our setup script, which can be found on [GitHub](https://github.com/cloudrift-ai/rift-utils).

:::

### Prerequisites

Before you begin, ensure your system has the following tools installed. These are required for downloading scripts, managing permissions, and installing packages.

- `curl`: For downloading scripts and files.
- `sudo`: For running commands as root.

```shell
sudo apt-get update
sudo apt-get install -y curl sudo
```

### Docker Engine & NVIDIA Container Toolkit

If you want your node to serve Docker containers, you need to install Docker Engine and NVIDIA Container Toolkit (if you have NVIDIA GPUs).

#### 1. Install Docker Engine

Up-to-date instructions can be found on the [Docker Website](https://docs.docker.com/engine/install/debian/).

```shell
# Uninstall conflicting packages
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done

# Setup repository
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
$(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install docker
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### 2. Install NVIDIA Drivers

You can check installed NVIDIA packages using the following command:

```shell
dpkg -l | grep -i nvidia
```

To check the version of the installed NVIDIA driver, you can use:

```shell
nvidia-smi
# or 
cat /proc/driver/nvidia/version
```

:::note

NVIDIA driver version and NVIDIA Utils version should match for the `nvidia-smi` command to work properly.

:::

:::info

On Ubuntu, **Failed to initialize NVML: Driver/library version mismatch** may happen because of the **unattended-upgrades** process. It automatically downloads and installs updates without user intervention. Usually, it's enough to reboot the system with `reboot now`.

:::

You can check if the NVIDIA driver is loaded and used by the system using the following command:

```shell
lsmod | grep nvidia
# or check if driver is used by your GPU:
lspci -k | grep -EA3 'VGA|3D|Display'
```

To install the latest NVIDIA driver, you can use the following command:

```shell
sudo apt-get install -y nvidia-driver-570-server nvidia-utils-570-server
```

#### 3. Install NVIDIA Container Toolkit (if you have NVIDIA GPUs)

Up-to-date instructions can be found on the [NVIDIA Website](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html).

```shell
# Configure the repository
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list    

# Install the NVIDIA Container Toolkit
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit

# Configure
sudo nvidia-ctk runtime configure --runtime=docker

# Restart Docker
sudo systemctl restart docker
```

:::tip
You can use [client_setup.sh](https://github.com/cloudrift-ai/rift-utils/blob/main/scripts/client_setup.sh) to install docker, drivers and rift:

```shell
sudo client_setup.sh --only=docker
sudo client_setup.sh --only=nvidia
sudo client_setup.sh --only=rift
```

:::

### Virtual Machine Service

If your node will serve virtual machines, you need to install and configure Libvirt. To allow Libvirt to use GPU device in pass-through mode, you have to make sure the NVIDIA driver is not installed or not used by the system.

You can check if the NVIDIA driver is loaded and used by the system using the following command:

```shell
lsmod | grep nvidia
# or check if driver is used by your GPU:
lspci -k | grep -EA3 'VGA|3D|Display'
```

#### 0. Remove NVIDIA Driver (if installed)

If the NVIDIA driver is installed, you can remove it using the following command:

```shell
sudo apt-get remove --purge '^nvidia-.*'
sudo apt autoremove
echo 'nouveau' | sudo tee -a /etc/modules
sudo rm /etc/X11/xorg.conf
```

:::info

Restart your machine to apply the changes.

:::

#### 1. Install System Dependencies

Install additional packages required by the service.

```shell
sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system genisoimage whois
```

#### 2. Configure Libvirt

Rift system service is run as the root user, so you need to set up libvirt to run under root as well.
Edit `/etc/libvirt/qemu.conf` and modify the `user` and `group` settings:

```shell
user = "root"
group = "root"
```

Then restart the `libvirtd` service:

```shell
sudo systemctl restart libvirtd
```

:::tip
You can use [client_setup.sh](https://github.com/cloudrift-ai/rift-utils/blob/main/scripts/client_setup.sh) to install libvirt and rift:

```shell
sudo client_setup.sh --only=vm
sudo client_setup.sh --only=rift
```

:::

### CloudRift System Service

Any Linux distribution is supported, but we typically test on Ubuntu 22.04.

```shell
curl -L https://cloudrift.ai/install-rift-service.sh | sudo sh
```

#### 1. CloudRift CLI

Install CloudRift CLI to configure the system service.

```shell
curl -L https://cloudrift.ai/install-rift.sh | sh
```

#### 2. Configure Credentials

Configure credentials using the rift command line tool by running:

```shell
sudo rift configure
```

:::note

We're running the rift system service as root, so we need to configure it as root.

:::

You can also edit the config manually. It is located at `/root/.config/cloudrift/credentials.yml`.

:::info

If editing manually, ensure you have the correct permissions and YAML formatting.

:::

#### 3. Restart System Service and Check Status

Restart CloudRift system service and check the status of the service and Docker Engine.

```shell
sudo systemctl restart rift
sudo systemctl status rift
sudo systemctl status docker
```

:::tip
You can use [client_setup.sh](https://github.com/cloudrift-ai/rift-utils/blob/main/scripts/client_setup.sh) to install and configure rift service:

```shell
sudo client_setup.sh --only=rift
```

:::

## Testing CloudRift Setup

### 1. Install CloudRift CLI

Install CloudRift CLI on your local machine. Installation instructions vary depending on your OS.

<Tabs groupId="operating-systems">
  <TabItem value="win" label="Windows">
    <DownloadWindowsInstaller/>
  </TabItem>
  <TabItem value="mac" label="Mac">

  ```shell
  curl -L https://cloudrift.ai/install-rift.sh | sh
  ```

  </TabItem>
  <TabItem value="linux" label="Linux">

  ```shell
  curl -L https://cloudrift.ai/install-rift.sh | sh
  ```

  </TabItem>
</Tabs>

### 2. Configure Credentials

Configure your credentials using the rift command line tool by running:

```shell
rift configure
```

### 3. Inspect the Cluster

Inspect the cluster. You should see all machines that you've installed CloudRift service on:

```shell
rift cluster info
```

### 4. Run Your First Job

Run your first job. For example, to run a simple echo command:

```shell
rift docker run --rm alpine echo "Hello CloudRift"
```

## Troubleshooting

- **Docker or NVIDIA driver issues:** Ensure you have rebooted after installation or removal of drivers. Check `nvidia-smi` and `docker info`.
- **Permission errors:** Make sure you are running commands as root or with `sudo`.
- **Service not starting:** Check logs with `sudo journalctl -u rift` or `sudo systemctl status rift`.

## Next Steps

For more information on how to use the CloudRift platform to lease your computational resources,
please see our [documentation](https://docs.cloudrift.ai) or send a request to [dc@cloudrift.ai](mailto:dc@cloudrift.ai).

We support a variety of integrations, e.g., marketplace, white-label website, custom integration, and more.
